<!DOCTYPE html>
<html prefix="        og: http://ogp.me/ns# article: http://ogp.me/ns/article#     " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<meta name="robots" content="noindex">
<title>Posts about aws | tech log</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../assets/css/custom.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://mnod.github.io/categories/aws.html">
<link rel="next" href="aws-2.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link rel="alternate" type="application/rss+xml" title="RSS for tag aws" hreflang="en" href="aws.xml">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
        
    <header id="header"><h1 id="brand"><a href="../" title="tech log" rel="home">

        <span id="blog-title">tech log</span>
    </a></h1>

        

        
    <nav id="menu"><ul>
<li><a href="../archive.html">Archives</a></li>
                <li><a href="index.html">Tags</a></li>
                <li><a href="../rss.xml">RSS feed</a></li>

    

    
    
    </ul></nav><div class="searchform" role="search">
                
<!-- DuckDuckGo custom search -->
 <form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
 <input type="hidden" name="sites" value="https://mnod.github.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
 <!-- End of custom search -->

            </div>
    </header><main id="content"><header><h1>Posts about aws</h1>
        <div class="metadata">
            
                <p class="feedlink">
                        
            <a href="aws.xml" hreflang="en" type="application/rss+xml">RSS feed</a>

                </p>

            

        </div>
    </header><div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20220820.html" class="u-url">nested cloudformation stack</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20220820.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-08-20T00:00:00Z" itemprop="datePublished" title="2022-08-20 00:00">2022-08-20 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>create sub stack vpc.yml</h3>
<pre><code>$ cat vpc.yml 
AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  CidrBlock:
    Type: String
    Default: "10.0.0.0/16"
  NameTag :
    Type: String
    Default: "nested stack"

Resources:
  VPC:

    Properties:
      CidrBlock: !Ref CidrBlock
      Tags:
      - Key: Name
        Value: !Ref NameTag

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value: !Ref NameTag

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: 
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway

Outputs:
  VpcId: 
    Value: !Ref VPC
  IgwId:
    Value: !Ref InternetGateway
</code></pre>
<pre><code>aws cloudformation validate-template --template-body file://vpc.yml
</code></pre>
<h3>create another sub stack subnet.yml</h3>
<pre><code>$ cat subnet.yml                                                                                                                                                [5/1860]
AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  NameTag:
    Type: String
    Default: "subnetnesting"
  VPC:
    Type: AWS::EC2::VPC::Id
  CidrBlock1:
    Type: String
    Default: "10.0.0.0/24"
  CidrBlock2:
    Type: String
    Default: "10.0.1.0/24"

Resources:
  Subnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref CidrBlock1
      AvailabilityZone:
         Fn::Select:
         - '0'
         - Fn::GetAZs:
             Ref: AWS::Region

  Subnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref CidrBlock2
      AvailabilityZone:
         Fn::Select:
         - '1'
         - Fn::GetAZs:
             Ref: AWS::Region

Outputs:
  SubnetId1:
    Value: !Ref Subnet1
  SubnetAz1:
    Value: !GetAtt Subnet1.AvailabilityZone
  SubnetId2:
    Value: !Ref Subnet2
  SubnetAz2:
    Value: !GetAtt Subnet2.AvailabilityZone
</code></pre>
<pre><code>aws cloudformation validate-template --template-body file://subnet.yml
</code></pre>
<h3>create parent stack parent.yml</h3>
<pre><code>$ cat parent.yml 
AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  NameTag:
    Default: nested stack test
    Type: String
  CidrBlock:
    Default: 10.1.0.0/16
    Type: String
  CidrBlock1:
    Default: 10.1.0.0/24
    Type: String
  CidrBlock2:
    Default: 10.1.1.0/24
    Type: String

Resources:
  VPC:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: vpc.yml
      Parameters:
        NameTag : !Ref NameTag
        CidrBlock: !Ref CidrBlock

  SUBNET:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: subnet.yml
      Parameters:
        NameTag : !Ref NameTag
        VPC: !GetAtt VPC.Outputs.VpcId
        CidrBlock1: !Ref CidrBlock1
        CidrBlock2: !Ref CidrBlock2

Outputs:
  VpcId:
    Value: !GetAtt VPC.Outputs.VpcId
  SubnetId1:
    Value: !GetAtt SUBNET.Outputs.SubnetId1
  SubnetId2:
    Value: !GetAtt SUBNET.Outputs.SubnetId2
</code></pre>
<pre><code>aws cloudformation validate-template --template-body file://parent.yml
</code></pre>
<h3>create or update stack</h3>
<pre><code>aws cloudformation package --template-file parent.yml --s3-bucket your-s3bucket-name --output-template-file parent_packaged.yml
aws cloudformation deploy --template-file parent_packaged.yml --stack-name nestedstack --tags Name=testnestedstack
</code></pre>
<h3>confirm</h3>
<pre><code>$ aws cloudformation describe-stacks --query 'Stacks[?Tags[?Key == `Name` &amp;&amp; Value == `testnestedstack`]]' | less

$ aws cloudformation describe-stacks --query 'Stacks[?Tags[?Key == `Name` &amp;&amp; Value == `testnestedstack`]].StackName' | jq -r .[] | while read stackname; do
&gt; aws cloudformation describe-stack-events --stack-name ${stackname}                                                                                                                                  &gt; done | less

$ aws cloudformation describe-stacks --query 'Stacks[?Tags[?Key == `Name` &amp;&amp; Value == `testnestedstack`]].StackName' | jq -r .[] | while read stackname; do
&gt; aws cloudformation describe-stack-resources --stack-name ${stackname}
&gt; done | less
</code></pre>
<h3>delete stack</h3>
<pre><code>aws cloudformation delete-stack --stack-name nestedstack
</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20220817.html" class="u-url">cognito user pool</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20220817.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-08-17T00:00:00Z" itemprop="datePublished" title="2022-08-17 00:00">2022-08-17 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>create user pool</h3>
<pre><code>aws cognito-idp create-user-pool --pool-name testpool1 --user-pool-tags 'key=Name,Value=testpool1' --admin-create-user-config 'AllowAdminCreateUserOnly=true' --account-recovery-setting 'RecoveryMechanisms=[{Priority=1,Name=admin_only}]'
aws cognito-idp list-user-pools --max-results 10
aws cognito-idp describe-user-pool --user-pool-id ap-northeast-1_xxxxxxxxx
</code></pre>
<p>remove user pool</p>
<pre><code>aws cognito-idp delete-user-pool --user-pool-id ap-northeast-1_xxxxxxxxx
</code></pre>
<h3>create user and set user password</h3>
<pre><code>aws cognito-idp list-users --user-pool-id ap-northeast-1_xxxxxxxxx
aws cognito-idp admin-create-user --user-pool-id ap-northeast-1_xxxxxxxxx --username testuser001 --temporary-password temporary_password
aws cognito-idp admin-set-user-password --user-pool-id ap-northeast-1_xxxxxxxxx --username testuser001 --password parmanent_password --permanent
</code></pre>
<h3>create role before import csv</h3>
<p>create policy json document</p>
<pre><code>$ jq . AllowCognitoCloudwatchLogs.policy
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:DescribeLogStreams",
        "logs:PutLogEvents"
      ],
      "Resource": [
        "arn:aws:logs:ap-northeast-1:xxxxxxxxxxxx:log-group:/aws/cognito/*"
      ]
    }
  ]
}
</code></pre>
<p>create policy</p>
<pre><code>aws iam create-policy --policy-name AllowCognitoCloudwatchLogs --policy-document file://AllowCognitoCloudwatchLogs.policy
aws iam list-policies --query 'Policies[?PolicyName==`AllowCognitoCloudwatchLogs`]'
aws iam delete-policy --policy-arn arn:aws:iam::xxxxxxxxxxxx:policy/AllowCognitoCloudwatchLogs
</code></pre>
<p>create assume role policy document</p>
<pre><code>$ jq . assumepolicy.json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "cognito-idp.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
</code></pre>
<p>create role</p>
<pre><code>aws iam create-role --role-name Import-Cognito-Userpool --assume-role-policy-document file://assumepolicy.json
aws iam list-roles --query 'Roles[?RoleName==`Import-Cognito-Userpool`]'
aws iam attach-role-policy --role-name Import-Cognito-Userpool --policy-arn arn:aws:iam::xxxxxxxxxxxx:policy/AllowCognitoCloudwatchLogs
</code></pre>
<h3>import csv to user pool</h3>
<p>create csv</p>
<pre><code>name,given_name,family_name,middle_name,nickname,preferred_username,profile,picture,website,email,email_verified,gender,birthdate,zoneinfo,locale,phone_number,phone_number_verified,address,updated_at,cognito:mfa_enabled,cognito:username
,,,,,,,,,dummy@example.com,true,,,,,,false,,,false,import001
</code></pre>
<p>import it</p>
<pre><code>aws cognito-idp create-user-import-job --user-pool-id ap-northeast-1_xxxxxxxxx --job-name import_job --cloud-watch-logs-role-arn arn:aws:iam::xxxxxxxxxxxx:role/service-role/Cognito-UserImport-Role
curl -v -T "PATH_TO_CSV_FILE" -H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
aws cognito-idp describe-user-import-job --user-pool-id ap-northeast-1_xxxxxxxxx --job-id import-xxxxxxxxxx
aws cognito-idp start-user-import-job --user-pool-id ap-northeast-1_xxxxxxxxx --job-id import-xxxxxxxxxx
</code></pre>
<p>remove unnecessary attributes and set user password</p>
<pre><code>aws cognito-idp list-users --user-pool-id ap-northeast-1_xxxxxxxxx
aws cognito-idp admin-delete-user-attributes --user-pool-id ap-northeast-1_xxxxxxxxx --username import001 --user-attribute-names 'email'
aws cognito-idp admin-set-user-password --user-pool-id ap-northeast-1_xxxxxxxxx --username import001 --password permanent_password --permanent
</code></pre>
<h3>disable / enable / delete user</h3>
<pre><code>aws cognito-idp list-users --user-pool-id ap-northeast-1_xxxxxxxxx --filter 'username="import001"'
aws cognito-idp admin-disable-user --user-pool-id ap-northeast-1_xxxxxxxxx --username import001
aws cognito-idp admin-enable-user  --user-pool-id ap-northeast-1_xxxxxxxxx --username import001
aws cognito-idp admin-delete-user  --user-pool-id ap-northeast-1_xxxxxxxxx --username import001
</code></pre>
<h3>user pool client</h3>
<pre><code>aws cognito-idp list-user-pool-clients --user-pool-id ap-northeast-1_xxxxxxxxx
aws cognito-idp create-user-pool-client --user-pool-id ap-northeast-1_xxxxxxxxx --client-name test-user-pool-client
aws cognito-idp describe-user-pool-client --user-pool-id ap-northeast-1_xxxxxxxxx --client-id xxxxxxxxxxxxxxxxxxxxxxxxx
aws cognito-idp delete-user-pool-client --user-pool-id ap-northeast-1_xxxxxxxxx --client-id xxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre>
<h3>example</h3>
<p>https://ashura156.hatenablog.com/entry/20180309/1520586674</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20220810.html" class="u-url">advanced cloudformation</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20220810.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-08-10T00:00:00Z" itemprop="datePublished" title="2022-08-10 00:00">2022-08-10 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>create an initial cloudformation stack</p>
<pre><code>aws cloudformation validate-template --template-body file://template-000.yml
aws cloudformation create-stack --stack-name mystack  --template-body file://mystack-000.yml
</code></pre>
<p>confirm the result</p>
<pre><code>aws cloudformation describe-stacks --stack-name mystack 
aws cloudformation describe-stack-resources --stack-name mystack 
aws cloudformation describe-stack-events --stack-name mystack
</code></pre>
<h3>change set</h3>
<p>create change set after editing template file</p>
<pre><code>aws cloudformation create-change-set --stack-name mystack --template-body file://mystack-001.yml --change-set-name mystack-001 --description 'create new Internet Gateway'
aws cloudformation list-change-sets --stack-name mystack 
aws cloudformation describe-change-set --stack-name mystack --change-set-name mystack-001
</code></pre>
<p>execute the change set</p>
<pre><code>aws cloudformation execute-change-set --stack-name mystack --change-set-name mystack-001
aws cloudformation list-change-sets --stack-name mystack
</code></pre>
<h3>drift</h3>
<p>detect stack drift after manual operation</p>
<pre><code>aws cloudformation detect-stack-drift --stack-name mystack 
aws cloudformation describe-stack-resource-drifts --stack-name mystack
</code></pre>
<p>create change set after editing template file to fit to current resource</p>
<pre><code>aws cloudformation create-change-set --stack-name mystack --template-body file://mystack-002.yml --change-set-name mystack-002 --description 'reflect manual operation'
aws cloudformation list-change-sets --stack-name mystack 
aws cloudformation describe-change-set --stack-name mystack --change-set-name mystack-002
</code></pre>
<p>execute the change set</p>
<pre><code>aws cloudformation execute-change-set --stack-name mystack --change-set-name mystack-002
</code></pre>
<p>remove change set when the status is false</p>
<pre><code>aws cloudformation delete-change-set --stack-name mystack --change-set-name mystack-002
</code></pre>
<h3>import</h3>
<p>create template file</p>
<pre><code>$ diff -u template.yml.orig template.yml
+Parameters:
+  ImageId:
+    Type: AWS::EC2::Image::Id
+  InstanceType:
+    Type: String
+  KeyName:
+    Type: AWS::EC2::KeyPair::KeyName
+  SecurityGroupId:
+    Type: AWS::EC2::SecurityGroup::Id
+  SubnetId:
+    Type: AWS::EC2::Subnet::Id
+

+  ## EC2 instance
+  EC2Instance1:
+    Type: AWS::EC2::Instance
+    DeletionPolicy: Retain
+    Properties: 
+      InstanceType: !Ref InstanceType
+      ImageId: !Ref ImageId
+      KeyName: !Ref KeyName
+      NetworkInterfaces: 
+        - DeviceIndex: "0"
+          GroupSet:
+            - !Ref SecurityGroupId
+          SubnetId: !Ref SubnetId
+      BlockDeviceMappings: 
+        - DeviceName: "/dev/xvda"
+          Ebs: 
+            VolumeType: "gp3"
+            VolumeSize: "8"
+      CreditSpecification:
+        CPUCredits: "standard"
</code></pre>
<p>create parameter file</p>
<pre><code>$ jq . parameters.json
[
  {
    "ParameterKey": "ImageId",
    "ParameterValue": "ami-007daaef51c7530e7"
  },
  {
    "ParameterKey": "InstanceType",
    "ParameterValue": "t4g.nano"
  },
  {
    "ParameterKey": "KeyName",
    "ParameterValue": "testkey"
  },
  {
    "ParameterKey": "SecurityGroupId",
    "ParameterValue": "sg-xxxxxxxxxxxxxxxxx"
  },
  {
    "ParameterKey": "SubnetId",
    "ParameterValue": "subnet-xxxxxxxxxxxxxxxxx"
  }
]
</code></pre>
<p>create a resources-to-import file</p>
<pre><code>$ jq . import.json 
[
  {
    "ResourceType": "AWS::EC2::Instance",
    "LogicalResourceId": "EC2Instance1",
    "ResourceIdentifier": {
      "InstanceId": "i-xxxxxxxxxxxxxxxxx"
    }
  }
]
</code></pre>
<p>create change set for import and execute it</p>
<pre><code>$ aws cloudformation validate-template --template-body file://template.yml
$ aws cloudformation create-change-set --stack-name mystack --change-set-name import-ec2instance --change-set-type IMPORT --resources-to-import file://import.json --template-body file://template.yml --parameters file://parameters.json
$ aws cloudformation describe-change-set --change-set-name import-ec2instance --stack-name mystack
$ aws cloudformation execute-change-set  --change-set-name import-ec2instance --stack-name mystack
</code></pre>
<p>confirm the result</p>
<pre><code>$ aws cloudformation describe-stacks --stack-name mystack
$ aws cloudformation describe-stack-events --stack-name mystack
</code></pre>
<p>detect stack drift</p>
<pre><code>$ aws cloudformation detect-stack-drift --stack-name mystack
$ aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id xxxxxxxxxxxxx-xxxx-xxxx-xxxxxxxxxxx
$ aws cloudformation describe-stack-resource-drifts --stack-name mystack
</code></pre>
<p>If any drift exist, edit stack template to fit to current resource and create and execute change set.</p>
<p>after that, change deletion policy to <code>Delete</code> and update stack if needed</p>
<pre><code>$ aws cloudformation update-stack --stack-name mystack --template-body file://template.yml --parameters file://parameters.json
</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20220808.html" class="u-url">ami</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20220808.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-08-08T00:00:00Z" itemprop="datePublished" title="2022-08-08 00:00">2022-08-08 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>create AMI</h3>
<pre><code>aws ec2 create-image --description 'backup ami of test server' --instance-id i-xxxx --name 'backup ami of test server' --no-reboot
aws ec2 deregister-image --image-id ami-xxxx 
aws ec2 describe-snapshots --owner-id xxxx --query 'Snapshots[?contains(Description, `ami-xxxx`)]'
</code></pre>
<h3>create an instance with AMI</h3>
<pre><code>aws ec2 run-instances \
--image-id ami-xxxx \
--instance-type t4g.nano \
--key-name testkey \
--security-group-ids sg-xxxx \
--subnet-id subnet-xxxx \
--credit-specification 'CpuCredits=standard' \
--tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=copied_instance}]' \
--associate-public-ip-address
</code></pre>
<h3>delete AMI</h3>
<pre><code>aws ec2 deregister-image --image-id ami-xxxx 
aws ec2 describe-snapshots --owner-id xxxx --query 'Snapshots[?contains(Description, `ami-xxxx`)].SnapshotId'
aws ec2 delete-snapshot --snapshot-id snap-xxxx
</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20220807.html" class="u-url">ebs</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20220807.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-08-07T00:00:00Z" itemprop="datePublished" title="2022-08-07 00:00">2022-08-07 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>create an EBS volume and attach to an EC2 instance</h3>
<pre><code>aws ec2 create-volume --availability-zone ap-northeast-1a --volume-type gp3 --size 1 --encrypted --tag-specifications 'ResourceType=volume,Tags=[{Key=Name,Value=test_volume}]'
aws ec2 describe-volumes --volume-id vol-xxxx
aws ec2 attach-volume --device /dev/xvdb --instance-id i-xxxx --volume-id vol-xxxx
</code></pre>
<h3>make partition and make filesystem</h3>
<pre><code>$ lsblk
$ sudo parted /dev/nvme1n1 print
$ sudo parted /dev/nvme1n1 mklabel gpt
$ sudo parted /dev/nvme1n1 mkpart home ext4 1MB 100%

$ sudo mkfs -t ext4 /dev/nvme1n1p1
$ sudo tune2fs -L homefs /dev/nvme1n1p1
$ ls -l /dev/disk/by-label/
</code></pre>
<h3>edit /etc/fstab and reboot</h3>
<pre><code>$ sudo mount /dev/nvme1n1p1 /mnt
$ sudo cp -pri /home/ubuntu /mnt
$ sudo cp -pri /etc/fstab /etc/fstab.000
$ sudo vi /etc/fstab
$ diff /etc/fstab /etc/fstab.000
3d2

aws ec2 reboot-instances --instance-ids i-xxxx --dry-run
</code></pre>
<h3>extend disk size</h3>
<pre><code>aws ec2 modify-volume --volume-id vol-xxxx --size 2
</code></pre>
<p>extend partition and filesystem</p>
<pre><code>$ lsblk
$ sudo growpart /dev/nvme1n1 1

$ df -hT /home
$ sudo resize2fs /dev/nvme1n1p1
</code></pre>
<h3>create snapshot</h3>
<pre><code>aws ec2 describe-snapshots --owner-id xxxx
aws ec2 create-snapshot --volume-id vol-xxxx --description 'test snapshot of homefs' --tag-specifications 'ResourceType=snapshot,Tags=[{Key=Name,Value=homefs}]'
aws ec2 describe-snapshots --owner-id xxxx --filters 'Name=volume-id,Values=vol-xxxx'
</code></pre>
<h3>create new EBS volume from snapshot</h3>
<pre><code>aws ec2 create-volume --availability-zone ap-northeast-1a --snapshot-id snap-xxxx --volume-type gp3 --encrypted --tag-specifications 'ResourceType=volume,Tags=[{Key=Name,Value=test_volume}]'
aws ec2 describe-volumes --volume-id vol-yyyy
</code></pre>
<h3>attach new volume and detach old volume</h3>
<pre><code>aws ec2 attach-volume --device /dev/xvdc --instance-id i-xxxx --volume-id vol-yyyy
aws ec2 stop-instances --instance-ids i-xxxx
aws ec2 detach-volume --no-force --instance-id i-xxxx --volume-id vol-xxxx
aws ec2 start-instances --instance-ids i-xxxx
</code></pre>
<h3>delete volume</h3>
<pre><code>aws ec2 delete-volume --volume-id vol-yyyy
aws ec2 describe-volumes
</code></pre>
<h3>delete snapshot</h3>
<pre><code>aws ec2 describe-snapshots --owner-id xxxx
aws ec2 delete-snapshot --snapshot-id snap-xxxx
</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20220627.html" class="u-url">let's encrrypt</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20220627.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-06-27T00:00:00Z" itemprop="datePublished" title="2022-06-27 00:00">2022-06-27 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <pre><code>certbot certonly \
--dry-run \
-d www.example.net \
-m yourname@example.net \
--preferred-challenges dns-01  \
--server https://acme-v02.api.letsencrypt.org/directory \
--manual \
--manual-auth-hook /home/user/work/letsencrypt/dns01-auth.sh \
--manual-cleanup-hook /home/user/work/letsencrypt/dns01-clean.sh \
--post-hook /home/user/work/letsencrypt/post-hook.sh \
--work-dir /home/user/work/letsencrypt/work \
--logs-dir /home/user/work/letsencrypt/logs \
--config-dir /home/user/work/letsencrypt/conf
</code></pre>
<ul>
<li>When you run certbot in non-root user, you have to specify --work-dir, --logs-dir, and --config-dir options.  These directories have to be writable with your user.</li>
<li>You can only publish new certificate file via certbot. Your new certificate file will pushed under config-dir directory. Afterward, you can deploy it with your deploy tool which you like. </li>
<li>The dns-01 challenge authentication only needs DNS validation and don't need to access via 80/tcp nor web server installation on your server.
When you use dns-01 challenge, you can use your script to update your dns resource to --manual-auth-hook (for authentication) and --manual-cleanup-hook (for cleanup entry).<br>
CERTBOT_DOMAIN varaible is used to show domain name which you want to use. CERTBOT_VALIDATION vaibale is used to show validation code.</li>
</ul>
<p>sample script which create validtion entry for aws route53</p>
<script src="https://gist.github.com/mnod/0ed9ec48287d3a785a1e648911720b37.js?file=dns01-auth.sh"></script><p>sample script which delete validtion entry for aws route53</p>
<script src="https://gist.github.com/mnod/0ed9ec48287d3a785a1e648911720b37.js?file=dns01-clean.sh"></script><pre><code>certbot renew \
--dry-run \
--post-hook /home/user/work/letsencrypt/post-hook.sh \
--work-dir /home/user/work/letsencrypt/work \
--logs-dir /home/user/work/letsencrypt/logs \
--config-dir /home/user/work/letsencrypt/conf
</code></pre>
<ul>
<li>Once you get your new certificate, you have to update your certificate periodically.</li>
</ul>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20210428.html" class="u-url">ses</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20210428.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-28T00:00:00Z" itemprop="datePublished" title="2021-04-28 00:00">2021-04-28 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>aws command</h3>
<pre><code>aws ses list-identities
</code></pre>
<p>destination.json </p>
<pre><code>{
  "ToAddresses": [
    "test@example.com"
  ],
  "CcAddresses": [],
  "BccAddresses": []
}
</code></pre>
<p>message.json </p>
<pre><code>{
  "Subject": {
    "Data": "test mail",
    "Charset": "UTF-8"
  },
  "Body": {
    "Text": {
      "Data": "Hi.\n\nThis is a test mail.",
      "Charset": "UTF-8"
    }
  }
}
</code></pre>
<pre><code>aws ses send-email --from noreply@example.net --destination file://destination.json --message file://message.json
</code></pre>
<p>template.json </p>
<pre><code>{
  "TemplateName": "testtemplate",
  "SubjectPart": "Greetings, {{name}}!",
  "TextPart": "Dear {{name}},\n\nYour favorite animal is {{favoriteanimal}}."
}
</code></pre>
<pre><code>aws ses list-templates
aws ses create-template --template file://template.json
aws ses get-template --template testtemplate
</code></pre>
<p>template-parameters.json </p>
<pre><code>{
  "name": "john",
  "favoriteanimal": "cat"
}
</code></pre>
<pre><code>aws ses test-render-template --template-name testtemplate --template-data file://template-data.json
aws ses send-templated-email --source noreply@example.net --destination file://destination.json --template testtemplate --template-data file://template-data.json
aws ses delete-template --template-name testtemplate
</code></pre>
<h3>python test script</h3>
<pre><code>#!/bin/usr/python

import boto3
import json

fromaddr = 'noreply@example.net'
destaddr = 'test@example.com'
destination = {
    'ToAddresses': [
        destaddr,
    ]
}

client = boto3.client('ses')

## send email
response = client.send_email(
    Source = fromaddr,
    Destination = destination,
    Message={
        'Subject': {
            'Data': 'test mail',
            'Charset': 'UTF-8'
        },
        'Body': {
            'Text': {
                'Data': 'Hi.\n\nThis is a test mail',
                'Charset': 'UTF-8'
            },
        }
    }
)
print(response)

templates = client.list_templates()
for template in templates['TemplatesMetadata']:
    response = client.get_template(
        TemplateName=template['Name']
    )
    print(response['Template'])

## create template
response = client.create_template(
    Template={
        "TemplateName": "testtemplate",
        "SubjectPart": "Greetings, {{name}}!",
        "TextPart": "Dear {{name}},\n\nYour favorite animal is {{favoriteanimal}}."
    }
)
templatedata = {
    "name": "john",
    "favoriteanimal": "cat"
}

## send templated email
response = client.send_templated_email(
    Source=fromaddr,
    Destination=destination,
    Template='testtemplate',
    TemplateData=json.dumps(templatedata)
)
print(response)

## delete template
response = client.delete_template(
    TemplateName='testtemplate'
)
print(response)

templates = client.list_templates()
for template in templates['TemplatesMetadata']:
    response = client.get_template(
        TemplateName=template['Name']
    )
    print(response['Template'])

</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20210422.html" class="u-url">route53</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20210422.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-22T00:00:00Z" itemprop="datePublished" title="2021-04-22 00:00">2021-04-22 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>aws command</h3>
<pre><code>aws route53 list-hosted-zones
aws route53 get-hosted-zone --id /hostedzone/xxxxxxxxxxxxxxxxxxxxx

aws route53 list-resource-record-sets   --hosted-zone-id /hostedzone/xxxxxxxxxxxxxxxxxxxxx --query "ResourceRecordSets[?Name == 'example.example.net.']"
aws route53 test-dns-answer --hosted-zone-id /hostedzone/xxxxxxxxxxxxxxxxxxxxx --record-name "example.example.net" --record-type "A"

aws route53 change-resource-record-sets  --hosted-zone-id /hostedzone/xxxxxxxxxxxxxxxxxxxxx --change-batch file://create.json
aws route53 get-change --id /change/xxxxxxxxxxxxxxxxxxxx
aws route53 change-resource-record-sets  --hosted-zone-id /hostedzone/xxxxxxxxxxxxxxxxxxxxx --change-batch file://delete.json
aws route53 get-change --id /change/xxxxxxxxxxxxxxxxxxxx
</code></pre>
<p>create.json</p>
<pre><code>{
  "Changes": [
    {
      "Action": "CREATE",
      "ResourceRecordSet": {
        "Name": "example.example.net",
        "Type": "A",
        "TTL": 3600,
        "ResourceRecords": [
          {
            "Value": "xxx.xxx.xxx.xxx"
          }
        ]
      }
    }
  ]
}
</code></pre>
<p>delete.json</p>
<pre><code>{
  "Changes": [
    {
      "Action": "DELETE",
      "ResourceRecordSet": {
        "Name": "example.example.net",
        "Type": "A",
        "TTL": 3600,
        "ResourceRecords": [
          {
            "Value": "xxx.xxx.xxx.xxx"
          }
        ]
      }
    }
  ]
}
</code></pre>
<h3>python sample script</h3>
<pre><code>#! /usr/bin/python2
import boto3
import time

client = boto3.client('route53')
zones = client.list_hosted_zones()

for zone in zones['HostedZones']:
    id =zone['Id']
    name = zone['Name']
    #print(client.get_hosted_zone(Id=id).get('HostedZone'))
    for set in client.list_resource_record_sets(HostedZoneId=id).get('ResourceRecordSets'):
        print(set)
    #action = 'CREATE'
    action = 'DELETE'
    address = 'xxx.xxx.xxx.xxx'

    batch = {
        'Changes': [
            {
                'Action': action,
                'ResourceRecordSet': {
                    'Name': 'example.%s' % name,
                    'Type': 'A',
                    'TTL': 3600,
                    'ResourceRecords': [
                        {
                            "Value": address
                        },
                    ],
                }
            },
        ]
    }
    response = client.change_resource_record_sets(
        HostedZoneId=id,
        ChangeBatch=batch
    )
    print(response)
    responseid = response['ChangeInfo']['Id']
    status = response['ChangeInfo']['Status']
    while ( status != 'INSYNC'):
        response = client.get_change(Id=responseid)
        status = response['ChangeInfo']['Status']
        time.sleep(30)
    else:
        print(response)
</code></pre>
<h3>cloud formation sample stack</h3>
<pre><code>aws cloudformation validate-template --template-body file://route53.yml
aws cloudformation create-stack --template-body file://route53.yml --parameters file://parameters.json --stack-name route53test
aws cloudformation describe-stack-events --stack-name route53test
aws cloudformation list-stack-resources --stack-name route53test
aws cloudformation delete-stack --stack-name route53test
</code></pre>
<p>route53.yml</p>
<pre><code>Parameters:
  HostedZoneId:
    Type: String
  Domain:
    Type: String
  Address:
    Type: String
Resources:
  myDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId : 
         Ref: HostedZoneId
      Name:  
        Fn::Join: 
            - '.'
            - - 'example'
              - !Ref Domain
      ResourceRecords:
      - Ref: Address
      TTL: '3600'
      Type: A
</code></pre>
<p>parameters.json</p>
<pre><code>[
  {
      "ParameterKey": "Address",
      "ParameterValue": "xxx.xxx.xxx.xxx"
  },
  {
      "ParameterKey": "HostedZoneId",
      "ParameterValue": "xxxxxxxxxxxxxxxxxxxxx"
  },
  {
      "ParameterKey": "Domain",
      "ParameterValue": "example.net"
  }
]
</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20201028.html" class="u-url">CloudWatch Events</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20201028.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-10-28T00:00:00Z" itemprop="datePublished" title="2020-10-28 00:00">2020-10-28 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>create and delete rule</p>
<pre><code>$ aws events list-rules
$ aws events put-rule --name testrule --schedule-expression "rate(60 minutes)"  --state DISABLED
$ aws events enable-rule --name testrule
$ aws events disable-rule --name testrule
$ aws events delete-rule --name testrule
$ aws events describe-rule --name testrule
</code></pre>
<p>create and remove targets</p>
<pre><code>$ aws events put-targets --rule testrule --targets '{"Input":"{\"interval\":60,\"rss\":\"https://status.aws.amazon.com/rss/ec2-ap-northeast-1.rss\",\"topicarn\":\"arn:aws:sns:ap-northeast-1:xxxxxxxxxxxx:mysnstopic\"}","Id":"1","Arn":"arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:mylambdafunction"}'
$ aws events remove-targets --rule testrule --ids 1
$ aws events list-targets-by-rule --rule testrule
</code></pre>
<p>CloudFormation stack template sample</p>
<pre><code>EventsRuleRssNotify:
  Type: 'AWS::Events::Rule'
  Properties:
    Description: 'rss notification'
    Name: rssnotifycf
    ScheduleExpression: 'rate(15 minutes)'
    State: ENABLED
    Targets:
      - Arn: !GetAtt LambdaRssNotification.Arn
        Id: "1"
        Input: !Ref INPUTJSON
</code></pre>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/20200209.html" class="u-url">ecs</a></h1>
        <div class="metadata">
            <!-- <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                mnod
            </span></p> -->
            <p class="dateline">
            <a href="../posts/20200209.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-02-09T00:00:00Z" itemprop="datePublished" title="2020-02-09 00:00">2020-02-09 00:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p><em>cluster</em></p>
<pre><code>$ aws ecs list-clusters 
$ aws ecs describe-clusters --clusters &lt;clusterArn&gt;

$ aws ecs create-cluster --cluster-name &lt;cluster-name&gt; --tags '[{"key": "Name","value": "test"}]'
$ aws ecs delete-cluster --cluster &lt;clusterArn&gt;

$ aws ecs delete-cluster --cluster &lt;clusterArn&gt;
</code></pre>
<p><em>task definition</em></p>
<pre><code>$ aws ecs list-task-definitions
$ aws ecs describe-task-definition --task-definition &lt;taskDefinitionArn&gt;

$ jq . task-definition.json
{
  "family": "sample-fargate",
  "networkMode": "awsvpc",
  "containerDefinitions": [
    {
      "name": "fargate-app",
      "image": "busybox",
      "essential": true,
      "command": [
        "sleep",
        "360"
      ]
    }
  ],
  "requiresCompatibilities": [
    "FARGATE"
  ],
  "cpu": "256",
  "memory": "512"
}
$ aws ecs register-task-definition --cli-input-json file://task-definition.json

$ aws ecs deregister-task-definition --task-definition &lt;taskDefinitionArn&gt;
</code></pre>
<p><em>task</em></p>
<p>When you use fargate and retrieve docker image from docker hub, you have to use internet gateway or nat gateway in the vpc.</p>
<pre><code>$ aws ecs list-tasks --cluster &lt;clusterArn&gt;
$ aws ecs describe-tasks --cluster &lt;clusterArn&gt; --tasks &lt;taskArn&gt;

$ jq . network-configuration.json
{
  "awsvpcConfiguration": {
    "subnets": [
      "&lt;subnet&gt;"
    ],
    "securityGroups": [
      "&lt;securitygroup&gt;"
    ],
    "assignPublicIp": "ENABLED"
  }
}
$ aws ecs run-task --task-definition &lt;taskDefinitionArn&gt; --cluster &lt;clusterArn&gt; --count 1 --launch-type FARGATE --network-configuration file://network-configuration.json

$ aws ecs stop-task --cluster &lt;clusterArn&gt; --task &lt;taskArn&gt;
</code></pre>
<p><em>tags</em></p>
<pre><code>$ aws ecs list-tags-for-resource --resource-arn &lt;resource-arn&gt;
$ aws ecs tag-resource --resource-arn &lt;resource-arn&gt; --tags '[{"key": "Name","value": "test"}]'
</code></pre>
<p><em>service</em></p>
<pre><code>$ aws ecs list-services --cluster &lt;clusterArn&gt;
$ aws ecs describe-services --cluster &lt;clusterArn&gt; --services &lt;serviceArn&gt;
$ aws ecs create-service --cluster &lt;clusterArn&gt; --service-name &lt;serviceName&gt; --task-definition &lt;task-definition&gt; --desired-count 1 --launch-type FARGATE --network-configuration file://network-configuration.json

$ aws ecs list-tasks --cluster &lt;clusterArn&gt;
$ aws ecs describe-tasks --cluster &lt;clusterArn&gt; --tasks &lt;taskArn&gt;

$ aws ecs update-service --cluster &lt;clusterArn&gt; --service &lt;serviceArn&gt; --desired-count 0
$ aws ecs delete-service --cluster &lt;clusterArn&gt; --service &lt;serviceArn&gt;
</code></pre>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="aws-2.html" rel="next">Older posts</a>
            </li>
        </ul></nav></main><footer id="footer"><p>Contents © 2022         <a href="mailto:mnod@example.com">mnod</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    
            <script src="../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
